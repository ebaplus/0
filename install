$choice = Read-Host "Instalacija podrske za Karticu(K) ili za USB(U) [Default: USB]"
$choice = ($choice + "").ToLower()

$useCard = switch ($choice) {
    "k" { $true }
    "c" { $true }
    "kartica" { $true }
    "card" { $true }
    "citac" { $true }
    default { $false }
}

$dest = "C:\eba"
New-Item -ItemType Directory -Force -Path $dest | Out-Null

# Download NEW SignErgy installer (ZIP)
$signergyZip = "$dest\UniCredit_SignErgy_Installer_new.zip"
Invoke-WebRequest -Uri "https://www.unicredit.ba/content/dam/cee2020-pws-bh1/Poduzetnici/Proizvodi%20i%20usluge/Dokumenti/UniCredit_SignErgy_Installer_new.zip" -OutFile $signergyZip

# Extract and cleanup
Expand-Archive -Path $signergyZip -DestinationPath $dest -Force
Remove-Item $signergyZip -Force

# Download e-baPlus
Start-BitsTransfer -Source "https://www.unicredit.ba/content/dam/cee2020-pws-bh1/Poduzetnici/Proizvodi%20i%20usluge/Dokumenti/e-baPlus%20SCManagement_v6.3.1_x64_bin.zip" -Destination "$dest\e-baPlus_SCManagement.zip"
Expand-Archive -Path "$dest\e-baPlus_SCManagement.zip" -DestinationPath "$dest" -Force
Remove-Item "$dest\e-baPlus_SCManagement.zip"

# Card or USB support
if ($useCard) {
    Invoke-WebRequest -Uri "https://www.unicredit.ba/content/dam/cee2020-pws-bh1/Poduzetnici/Proizvodi%20i%20usluge/Dokumenti/ActivClient%207.1.0%20x64%20FIX168.exe" -OutFile "$dest\ActivClient.exe"
} else {
    Start-BitsTransfer -Source "https://www.unicredit.ba/content/dam/cee2020-pws-bh1/Poduzetnici/Proizvodi%20i%20usluge/Dokumenti/SafeNetAuthenticationClient-8-x64-8.3.msi.zip" -Destination "$dest\SafeNetAuthenticationClient.zip"
    Expand-Archive -Path "$dest\SafeNetAuthenticationClient.zip" -DestinationPath "$dest" -Force
    Remove-Item "$dest\SafeNetAuthenticationClient.zip"
}

# Install SignErgy silently
$signergyExe = Get-ChildItem -Path $dest -Filter "UniCredit_SignErgy_Installer.exe" -Recurse | Select-Object -First 1
if ($signergyExe) {
    Start-Process $signergyExe.FullName -ArgumentList "/SP- /VERYSILENT /NORESTART /SUPPRESSMSGBOXES" -Wait
}

# Install e-baPlus silently
Start-Process "$dest\e-baPlus_SCManagement_x64.exe" -ArgumentList "/S /v/qn" -Wait

if ($useCard) {
    try {
        Start-Process "$dest\ActivClient.exe" -ArgumentList "/quiet /norestart" -Wait
    } catch {
        Write-Host "Molimo dovršite instalaciju ako se pojavi prozor..." -ForegroundColor Yellow
    }
} else {
    Start-Process "msiexec.exe" -ArgumentList "/i `"$dest\SafeNetAuthenticationClient-8-x64-8.3.msi`" /quiet /norestart" -Wait
}

# Shortcuts and links
$desktop = [Environment]::GetFolderPath("Desktop")
$shortcutPath = "$desktop\e-baPlus.url"
$url = "https://ebaplus.unicreditbank.ba/ebaPlus/"
@"
[InternetShortcut]
URL=$url
"@ | Set-Content -Encoding ASCII -Path $shortcutPath

function New-InternetShortcut {
    param ($path, $url)
    @"
[InternetShortcut]
URL=$url
"@ | Set-Content -Encoding ASCII -Path $path
}
# Create shortcuts in C:\eba
New-InternetShortcut -path "$dest\Registracija.url" -url "https://www.unicreditbank.ba/ebank/registracija/index.html"
New-InternetShortcut -path "$dest\Obnova certifikata.url" -url "https://www.unicreditbank.ba/ebank/reizdavanjeBH/"
New-InternetShortcut -path "$dest\Upute i ostali linkovi.url" -url "https://www.unicredit.ba/ba/poduzetnici/proizvodi_i_usluge/internet_bankarstvo2.html#linkovizapreuzimanjeaplikacije_4"

# Write instructions
@"
1. Registracija – Prva registracija uredjaja nakon sto dobijete podatke putem Poste + fizicki uredjaj:

   Koristite link: https://www.unicreditbank.ba/ebank/registracija/index.html 
   ili shortcut: Registracija.

   - Pri vrhu ekrana prihvatite SignErgy aplikaciju.
   - Unesite vase podatke: ID (AAxxxx) i PIN.
   - Kliknite dugme "Nastavi", potvrdite vase podatke.
   - Kliknite dugme "Nastavi", ZAPISITE VASU SIFRU ZA OTKLJUCAVANJE – OVO JE JEDINI PUT KAD JE ONA VIDLjIVA I DOSTUPNA.
   - Klikajte "Nastavi" dok ne dodjete na 100%, zatim izvadite i vratite USB.

   Nakon 2-3 minute pokusajte pristupiti: https://ebaplus.unicreditbank.ba/ebaPlus/

2. Obnova certifikata:

   Koristite link: https://www.unicreditbank.ba/ebank/reizdavanjeBH/ 
   ili shortcut: Obnova certifikata.

   - Pri vrhu prihvatite SignErgy.
   - Kliknite "Nastavi" i pratite korake do 100%.
   - Na 100%, izvadite USB i nakon 5-10 minuta pokusajte pristupiti.

3. Upute i ostali linkovi:

   Koristite link: 
   https://www.unicredit.ba/ba/poduzetnici/proizvodi_i_usluge/internet_bankarstvo2.html#linkovizapreuzimanjeaplikacije_4 
   ili shortcut: Upute i ostali linkovi.

   Svi kontakti, dodatne instalacije i linkovi su tamo dostupni.

   Kontakt email: ebaplus@unicreditgroup.ba
"@ | Set-Content -Encoding UTF8 -Path "$dest\Upute.txt"

Clear-Host


Write-Host "`nInstalacija završena. Sve datoteke i upute se nalaze u C:\eba" -ForegroundColor Green
